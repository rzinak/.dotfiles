#!/bin/bash

WAKATIME_CONFIG="$HOME/.wakatime.cfg"
if [[ ! -f "$WAKATIME_CONFIG" ]]; then
    echo " No config"
    exit 1
fi

API_KEY=$(grep "^api_key=" "$WAKATIME_CONFIG" | cut -d'=' -f2)

CACHE_FILE="/tmp/wakatime_cache"
CACHE_DURATION=300 

if [[ -z "$API_KEY" ]]; then
    echo " No API key"
    exit 1
fi

if [[ -f "$CACHE_FILE" && $(($(date +%s) - $(stat -c %Y "$CACHE_FILE"))) -lt $CACHE_DURATION ]]; then
    cat "$CACHE_FILE"
    exit 0
fi

response=$(curl -s -H "Authorization: Basic $(echo -n "$API_KEY:" | base64)" \
    "https://wakatime.com/api/v1/users/current/summaries?range=today")

total_seconds=$(echo "$response" | jq -r '.data[0].grand_total.total_seconds // 0' | cut -d'.' -f1)

if [[ "$total_seconds" == "0" || "$total_seconds" == "null" ]]; then
    echo " 0h 0m"
else
    hours=$((total_seconds / 3600))
    minutes=$(((total_seconds % 3600) / 60))
    
    if [[ $hours -gt 0 ]]; then
        output=" ${hours}h ${minutes}m"
    else
        output=" ${minutes}m"
    fi
    
    echo "$output"
    
    echo "$output" > "$CACHE_FILE"
fi
